name: ğŸ”„ Sync MCP Configuration

on:
  push:
    branches: [ main, master ]
    paths:
      - 'mcp.json'
      - 'scripts/sync-mcp-config.js'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para sincronizar'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  sync-mcp:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment: [dev, staging, prod]
        
    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ”§ Install Dependencies
      run: npm ci
      
    - name: ğŸ” Install Doppler CLI
      run: |
        curl -Ls https://cli.doppler.com/install.sh | sh
        sudo mv /tmp/doppler /usr/local/bin/doppler
        
    - name: ğŸ”‘ Setup Doppler
      env:
        DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
      run: |
        echo $DOPPLER_TOKEN | doppler configure set token --scope /
        doppler setup --project app-financeiro --config ${{ matrix.environment }} --no-interactive
        
    - name: ğŸ“‹ Generate MCP Templates
      run: |
        npm run mcp:sync:generate
        
    - name: ğŸ”„ Sync Configuration
      run: |
        npm run mcp:sync:all
        
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mcp-config-${{ matrix.environment }}
        path: |
          mcp.template.json
          mcp.resolved.json
          sync-mcp.sh
          docker-compose.yml
        retention-days: 30
        
    - name: ğŸ“Š Validate Configuration
      run: |
        # Validar se os arquivos JSON estÃ£o corretos
        node -e "JSON.parse(require('fs').readFileSync('mcp.template.json', 'utf8')); console.log('âœ… Template vÃ¡lido')"
        node -e "JSON.parse(require('fs').readFileSync('mcp.resolved.json', 'utf8')); console.log('âœ… Resolved vÃ¡lido')"
        
    - name: ğŸš¨ Notify on Failure
      if: failure()
      run: |
        echo "âŒ SincronizaÃ§Ã£o falhou para ambiente: ${{ matrix.environment }}"
        echo "ğŸ” Verifique os logs para mais detalhes"

  # Job para enviar para diferentes sistemas
  deploy-configs:
    needs: sync-mcp
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: mcp-config-prod
        
    - name: ğŸ” Setup Doppler for Production
      env:
        DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN_PROD }}
      run: |
        curl -Ls https://cli.doppler.com/install.sh | sh
        sudo mv /tmp/doppler /usr/local/bin/doppler
        echo $DOPPLER_TOKEN | doppler configure set token --scope /
        
    - name: ğŸ¯ Deploy to Production Systems
      run: |
        echo "ğŸš€ Deploying to production systems..."
        # Aqui vocÃª pode adicionar comandos para:
        # - SSH para servidores e atualizar configs
        # - Integrar com Kubernetes secrets
        # - Atualizar outros sistemas
        
    - name: âœ… Success Notification
      run: |
        echo "ğŸ‰ MCP Configuration sincronizada com sucesso!"
        echo "ğŸ“Š Ambientes: dev, staging, prod"
        echo "ğŸ”— Artifacts disponÃ­veis por 30 dias" 